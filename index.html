<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ZETA: Descent into Void</title>
  <meta name="viewport" content="width=320,initial-scale=1,user-scalable=no">
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <style>
    html, body {margin:0;height:100%;overflow:hidden;background:#1a001a;}
    body {width:100vw;height:100vh;}
    #gameCanvas {
      display: block;
      width: 100vw;
      height: 100vh;
      background: #1a001a;
      image-rendering: pixelated;
      touch-action: none;
    }
    .dialog {
      font-family: 'Press Start 2P', monospace;
      background: rgba(20,0,30,0.96);
      color: #fff;
      border: 2px solid #5c1a5c;
      position: absolute;
      left: 50%; bottom: 24px; transform: translateX(-50%);
      min-width: 220px; max-width: 90vw;
      padding: 12px 16px;
      z-index: 10;
      font-size: 14px;
      border-radius: 8px;
      box-shadow: 0 0 12px #000a;
      display: none;
      user-select: none;
      pointer-events: auto;
    }
    .controls {
      display: none; position: absolute; bottom: 18px; left: 50%; transform:translateX(-50%);
      z-index: 20; gap: 12px; width: 100vw; justify-content: center;
    }
    .controls button {
      width: 54px; height: 54px;
      background: #330033cc;
      border: 2px solid #5c1a5c;
      border-radius: 10px;
      color: #fff; font-size: 32px; font-family: inherit;
      margin: 0 4px; user-select: none; outline: none;
      box-shadow: 0 2px 12px 0 #0006;
      pointer-events: auto;
      touch-action: none;
      transition: filter 0.12s, background 0.12s;
    }
    .controls button.pressed { background: #6622aa; filter: brightness(1.25); }
    @media (max-width: 700px) {
      .controls { display: flex; }
      .dialog { font-size: 18px; min-width: 50vw;}
    }
  </style>
</head>
<body>
  <canvas id="gameCanvas" width="320" height="180"></canvas>
  <div class="dialog" id="dialog"></div>
  <div class="controls" id="controls">
    <button id="btn-left">&#8592;</button>
    <button id="btn-right">&#8594;</button>
    <button id="btn-jump">&#8593;</button>
    <button id="btn-attack">&#9935;</button>
    <button id="btn-interact">E</button>
  </div>
  <script>
  // === ZETA: Descent into Void â€” Pure Canvas Version, FIXED MOVEMENT & ATTACK ===

  // --- Config ---
  const CANVAS_BASE_W = 320, CANVAS_BASE_H = 180;
  const TILE = 16;
  const PLAYER_SIZE = 16;
  const PLAYER_SPEED = 1.7;
  const PLAYER_JUMP = 3.8;
  const GRAVITY = 0.18;
  const ROOM_BG = "#1a001a";
  const FOG_COLOR = "rgba(40,0,40,0.13)";
  const font = "'Press Start 2P', monospace";
  let dialogActive = false;
  let attackTimer = 0;

  // --- Canvas / Context ---
  const canvas = document.getElementById('gameCanvas');
  const ctx = canvas.getContext('2d');
  let scale = 1;

  // --- Mobile Controls State ---
  let isMobile = /Mobi|Android|iPhone|iPad|iPod|Windows Phone/i.test(navigator.userAgent) || window.innerWidth < 700;
  document.getElementById("controls").style.display = isMobile ? "flex" : "none";
  let mobileLeft = false, mobileRight = false, mobileJump = false, mobileAttack = false, mobileInteract = false;
  function bindMobileControls() {
    // Button IDs must match variable names after 'btn-' and be lowercase
    const map = {
      "btn-left": "mobileLeft",
      "btn-right": "mobileRight",
      "btn-jump": "mobileJump",
      "btn-attack": "mobileAttack",
      "btn-interact": "mobileInteract"
    };
    Object.entries(map).forEach(([btnId, flag]) => {
      const el = document.getElementById(btnId);
      el.addEventListener("touchstart", e => { e.preventDefault(); window[flag] = true; el.classList.add("pressed"); }, {passive:false});
      el.addEventListener("touchend", e => { e.preventDefault(); window[flag] = false; el.classList.remove("pressed"); }, {passive:false});
      el.addEventListener("touchcancel", e => { window[flag] = false; el.classList.remove("pressed"); });
    });
  }
  bindMobileControls();

  // --- Responsive Canvas ---
  function resizeCanvas() {
    const w = window.innerWidth, h = window.innerHeight;
    scale = Math.floor(Math.min(w/CANVAS_BASE_W, h/CANVAS_BASE_H));
    canvas.style.width = (CANVAS_BASE_W*scale)+"px";
    canvas.style.height = (CANVAS_BASE_H*scale)+"px";
    canvas.style.position = "absolute";
    canvas.style.left = "50%";
    canvas.style.top = "50%";
    canvas.style.transform = `translate(-50%, -50%) scale(1)`;
    document.body.style.overflow = "hidden";
  }
  window.addEventListener("resize", resizeCanvas); resizeCanvas();

  // --- Simple Assets (drawn, no images) ---
  function drawTile(ch, x, y) {
    if (ch === '=' || ch === '|') { // Wall/floor
      ctx.fillStyle = ch === '=' ? "#4b236c" : "#33103c";
      ctx.fillRect(x, y, TILE, TILE);
    } else if (ch === '+') { // Door
      ctx.strokeStyle = "#a0a";
      ctx.lineWidth = 3;
      ctx.strokeRect(x+2, y+2, TILE-4, TILE-4);
      ctx.strokeStyle = "#fff";
      ctx.lineWidth = 1;
    } else if (ch === '*') { // Cultist enemy
      ctx.fillStyle = "#a01034";
      ctx.fillRect(x+2, y+4, 12, 10);
      ctx.fillStyle = "#f33";
      ctx.fillRect(x+5, y+7, 2, 2);
      ctx.fillRect(x+9, y+7, 2, 2);
    } else if (ch === 'n') { // NPC
      ctx.fillStyle = "#4060c0";
      ctx.fillRect(x+2, y+2, 12, 13);
      ctx.fillStyle = "#fff";
      ctx.fillRect(x+6, y+5, 4, 4);
      ctx.fillStyle = "#0ef";
      ctx.fillRect(x+7, y+7, 2, 2);
    } else if (ch === '@') { // Terminal/lore
      ctx.fillStyle = "#333";
      ctx.fillRect(x+3, y+6, 10, 6);
      ctx.fillStyle = "#0f0";
      ctx.fillRect(x+6, y+7, 4, 2);
    }
  }

  // --- Game World ---
  const rooms = {
    sanctum: {
      name: "Sanctum of ðŸœ²",
      map: [
        "====================",
        "=                  =",
        "=   n        @     =",
        "=                  =",
        "=        *         =",
        "=     ===+===      =",
        "=                  =",
        "=                  =",
        "====================",
      ],
      doors: [
        { x: 10, y: 5, target: "voidhall", tx: 2, ty: 6 }
      ],
      bg: "#1a001a"
    },
    voidhall: {
      name: "Hall of the Void",
      map: [
        "====================",
        "=                  =",
        "=   *          *   =",
        "=                  =",
        "=        @         =",
        "=   ===+===        =",
        "=                  =",
        "=                  =",
        "====================",
      ],
      doors: [
        { x: 7, y: 5, target: "sanctum", tx: 10, ty: 6 }
      ],
      bg: "#170020"
    }
  };

  let gameState = {
    room: "sanctum",
    player: {x: 32, y: 110, vx: 0, vy: 0, hp: 6, onGround: false, facing: 1, attacking: false},
    dialog: null,
    enemies: [],
    notes: [],
    corruption: 0
  };

  // --- Player Drawing ---
  function drawPlayer(x, y, facing, attacking, attackFrame) {
    ctx.save();
    ctx.translate(x+PLAYER_SIZE/2, y+PLAYER_SIZE/2);
    ctx.scale(facing,1);
    ctx.fillStyle = "#c0a0ff";
    ctx.fillRect(-8, -8, 16, 16);
    ctx.fillStyle = "#fff";
    ctx.fillRect(-4, -4, 8, 8);
    ctx.restore();
    // Particle trail
    if (Math.random()<0.5) {
      ctx.globalAlpha = 0.22;
      ctx.fillStyle = "#c0a0ff";
      ctx.beginPath();
      ctx.arc(x+8+Math.random()*4-2, y+16, 2+Math.random()*2, 0, 6.29);
      ctx.fill();
      ctx.globalAlpha = 1;
    }
    // Attack animation (sigil flash in front)
    if (attacking && attackFrame>0) {
      ctx.save();
      ctx.globalAlpha = 0.75;
      ctx.strokeStyle = "#b7a3ff";
      ctx.lineWidth = 2.3;
      let fx = facing>0 ? x+18 : x-2;
      let fy = y+8;
      ctx.beginPath();
      ctx.moveTo(fx, fy-6); ctx.lineTo(fx, fy+6);
      ctx.moveTo(fx-6, fy); ctx.lineTo(fx+6, fy);
      ctx.moveTo(fx-5, fy-5); ctx.lineTo(fx+5, fy+5);
      ctx.moveTo(fx-5, fy+5); ctx.lineTo(fx+5, fy-5);
      ctx.stroke();
      ctx.restore();
    }
  }

  // --- Draw Hearts/Corruption Meter ---
  function drawHearts(hp) {
    for (let i=0; i<Math.ceil(hp/2); i++) {
      ctx.fillStyle = "#f33";
      ctx.beginPath();
      ctx.moveTo(20+i*18, 17); ctx.bezierCurveTo(20+i*18,11,12+i*18,11,12+i*18,17);
      ctx.bezierCurveTo(12+i*18,23,20+i*18,27,20+i*18,27);
      ctx.bezierCurveTo(20+i*18,27,28+i*18,23,28+i*18,17);
      ctx.bezierCurveTo(28+i*18,11,20+i*18,11,20+i*18,17);
      ctx.fill();
    }
  }

  // --- Dialog System ---
  const dialogDiv = document.getElementById("dialog");
  function showDialog(text, choices) {
    dialogActive = true;
    dialogDiv.style.display = "block";
    if (typeof text === "string") text = [text];
    let idx = 0, ci = 0, lines = text, fullText = '';
    function typeLine() {
      if (idx >= lines.length) {
        if (choices) {
          dialogDiv.innerHTML += "<br><br>";
          choices.forEach((c, i) => dialogDiv.innerHTML += `<span style="color:#c0f">${i+1}. ${c[0]}</span><br>`);
          dialogDiv.onclick = null;
        } else {
          dialogDiv.onclick = hideDialog;
        }
        return;
      }
      let line = lines[idx], out = '';
      function tick() {
        if (ci < line.length) {
          out += line[ci];
          dialogDiv.innerHTML = fullText + out + "<span style='opacity:0.3'>_</span>";
          ci++;
          setTimeout(tick, 22);
        } else {
          fullText += out+"<br>"; idx++; ci=0;
          setTimeout(typeLine, 160);
        }
      }
      tick();
    }
    dialogDiv.onclick = hideDialog;
    typeLine();
  }
  function hideDialog() {
    dialogActive = false;
    dialogDiv.style.display = "none";
    dialogDiv.onclick = null;
  }
  dialogDiv.addEventListener("click", e => {
    if (!dialogActive) return;
    if (gameState.dialog && gameState.dialog.choices) {
      let y = e.offsetY, idx = Math.floor((y-60)/28);
      if (gameState.dialog.choices[idx]) {
        gameState.dialog.choices[idx][1]();
        hideDialog();
      }
    }
  });

  // --- Input ---
  let keys = {};
  window.addEventListener("keydown", e => {
    keys[e.key.toLowerCase()]=true;
    // Attack: Space
    if (e.key === " " && !dialogActive) {
      startAttack();
    }
  });
  window.addEventListener("keyup", e => keys[e.key.toLowerCase()]=false);

  // --- Attack logic ---
  function startAttack() {
    let p = gameState.player;
    if (!p.attacking) {
      p.attacking = true;
      attackTimer = 12; // ~0.2s
    }
  }

  // --- Main Loop ---
  function gameLoop() {
    // --- Update Logic ---
    // Player input
    let p = gameState.player;
    let left = keys['arrowleft']||keys['a']||mobileLeft, right = keys['arrowright']||keys['d']||mobileRight;
    let jump = keys['arrowup']||keys['w']||mobileJump;
    // Movement only if not in dialog
    if (!dialogActive) {
      if (left) { p.vx = -PLAYER_SPEED; p.facing = -1; }
      else if (right) { p.vx = PLAYER_SPEED; p.facing = 1; }
      else p.vx = 0;
      if (jump && p.onGround) { p.vy = -PLAYER_JUMP; mobileJump=false; }
      // Mobile attack
      if (mobileAttack) {
        startAttack();
        mobileAttack = false;
      }
    } else {
      p.vx = 0;
    }
    // Gravity
    p.vy += GRAVITY;
    // Collisions (simple, only for walls/floors)
    let nextX = p.x + p.vx, nextY = p.y + p.vy;
    let col = collideWithMap(nextX, p.y);
    if (!col.x) p.x = nextX; else p.vx = 0;
    col = collideWithMap(p.x, nextY);
    if (!col.y) { p.y = nextY; p.onGround = false; }
    else { p.vy = 0; p.onGround = true; }
    // Room door switch
    let door = doorAt(Math.floor((p.x+8)/TILE), Math.floor((p.y+8)/TILE));
    if (door && !dialogActive) {
      let d = rooms[gameState.room].doors.find(d=>d.x===door.x&&d.y===door.y);
      if (d) switchRoom(d.target, d.tx, d.ty, p.hp);
    }
    // Interact (E/btn)
    if ((keys['e']||mobileInteract) && !dialogActive) {
      let tx = Math.floor((p.x+8)/TILE), ty = Math.floor((p.y+8)/TILE);
      let sym = charAt(tx, ty-1);
      if (sym==='n') {
        showDialog(["We waited for you, ðŸœ².","The unbelievers are near."], [
          ["Accept the truth", () => { showDialog("A strange energy fills the air..."); gameState.corruption++; }],
          ["Walk away", () => {}]
        ]);
      }
      if (sym==='@') showDialog(["Day 17: Flakious spoke through the void."]);
      mobileInteract = false;
    }
    // Attack timer update
    if (p.attacking) {
      attackTimer--;
      if (attackTimer<=0) { p.attacking = false; attackTimer = 0; }
    }
    // --- Render ---
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.fillStyle = rooms[gameState.room].bg;
    ctx.fillRect(0,0,canvas.width,canvas.height);
    ctx.globalAlpha = 0.14+Math.random()*0.04;
    ctx.fillStyle = FOG_COLOR;
    ctx.fillRect(0,0,canvas.width,canvas.height); ctx.globalAlpha = 1;
    // Draw map
    let map = rooms[gameState.room].map;
    for (let y=0;y<map.length;y++)
      for (let x=0;x<map[0].length;x++)
        drawTile(map[y][x], x*TILE, y*TILE);
    // Draw player
    drawPlayer(p.x,p.y,p.facing,p.attacking,attackTimer);
    // Draw UI
    drawHearts(p.hp);
    // Room label
    ctx.font = "bold 16px "+font; ctx.fillStyle="#b3aaff";
    ctx.textAlign = "center";
    ctx.fillText(rooms[gameState.room].name, CANVAS_BASE_W/2, 32);
    requestAnimationFrame(gameLoop);
  }

  // --- Map helpers ---
  function charAt(tx,ty) {
    let map = rooms[gameState.room].map;
    if (tx<0||ty<0||ty>=map.length||tx>=map[0].length) return ' ';
    return map[ty][tx];
  }
  function collideWithMap(nx, ny) {
    let tx = Math.floor((nx+8)/TILE), ty = Math.floor((ny+16)/TILE);
    let ch = charAt(tx,ty);
    if (ch==='='||ch==='|') return {x: true, y: true};
    return {x: false, y: false};
  }
  function doorAt(tx,ty) {
    let map = rooms[gameState.room].map;
    if (tx<0||ty<0||ty>=map.length||tx>=map[0].length) return null;
    if (map[ty][tx]==='+') return {x:tx,y:ty};
    return null;
  }
  function switchRoom(name, tx, ty, hp) {
    gameState.room = name;
    gameState.player.x = tx*TILE;
    gameState.player.y = ty*TILE;
    gameState.player.hp = hp||6;
  }

  // --- Game Boot ---
  showDialog("Welcome to ZETA: Descent into Void");
  requestAnimationFrame(gameLoop);

  </script>
</body>
</html>